{% extends "default.html" %}
{% block head_inside %}
	<style>
		#main{
			text-align:center;
		}
		#div_slam{
			border:solid 1px #CACACA;
			display:inline-block;
		}
	</style>
	{% load staticfiles %}
	<script type='text/javascript' src="{% static 'js/custom/slam/phaser.js' %}"></script>
{% endblock %}
{% block main_inside %}
	<script>
		// dokumentasi http://phaser.io/docs/2.3.0/Phaser.Game.html
		
		var PI = 3.14159;
		var game = new Phaser.Game(640, 480, Phaser.AUTO, 'div_slam',null, true);
		var echo = console.log
		var frame = 0;
		var avatar;
		var p = {x:0,y:0};
		var vehicle = {
			move_rate:50, 
			next_move:0,
			rot_expected:0,
			rot_current:0,
			rot_diff:0,
			pos_expected: {
				x:0,
				y:0
			},
			pos_current: {
				x:0,
				y:0
			},
			pos_diff: 0,
			
			calculate_rot_diff: function(current_rot) {
				this.rot_diff = Math.abs(current_rot-vehicle.rot_expected);
			},
			calculate_pos_diff: function(current_x,current_y) {
				this.pos_diff = Math.sqrt((this.pos_expected.x-current_x)*(this.pos_expected.x-current_x) + (this.pos_expected.y-current_y)*(this.pos_expected.y-current_y));
			},
		};
		
		var main_state = {
			init: function() {
				
			},
			
			preload: function() {
				game.load.image('sprite_vehicle', '/static/img/custom/slam/avatar.png');
			},

			create: function() { 
				game.physics.startSystem(Phaser.Physics.ARCADE);
				avatar = game.add.sprite(250, 300, 'sprite_vehicle');
				avatar.anchor.set(0.5);
				game.physics.enable(avatar, Phaser.Physics.ARCADE);
				avatar.body.allowRotation = true;
				this.bmd = game.add.bitmapData(game.width,game.height);
				this.bmd.addToWorld();
				this.bmd.clear();
				this.info = game.add.text(20,20,"Bismillah",{font:"normal 12px Arial"});
				this.plot();
				
				this.path = new Phaser.Line(0,0,0,0);
			},
			update: function() {
				if (game.input.activePointer.isDown) {
					this.vehicle_setGoal();
				}
				
				if (vehicle.rot_diff>0.2)
				{
					if (vehicle.rot_diff>PI/2)
					{
						/**-- which way is shorter, turn left or right? */
						if (-avatar.rotation>vehicle.rot_expected) {
							/**-- right one is shorter */
							//~ var to_rot = (avatar.rotation - 0.05);
							//~ if (to_rot> -PI)
								//~ to_rot = PI-(-to_rot-PI);
							vehicle.rot_current = (vehicle.rot_current + 0.05);
							avatar.rotation = vehicle.rot_current;
						}
						else {
							/**-- left one is shorter */
							//~ avatar.rotation = (avatar.rotation + 0.05)% PI;
							vehicle.rot_current = (vehicle.rot_current - 0.05);
							avatar.rotation = vehicle.rot_current;
						}
					}
					else
					{
						/**-- which way is shorter, turn left or right? */
						if (avatar.rotation>vehicle.rot_expected) {
							/**-- right one is shorter */
							avatar.rotation = (avatar.rotation - 0.05)% PI;
						}
						else {
							/**-- left one is shorter */
							avatar.rotation = (avatar.rotation + 0.05)% PI;
						}
					}
					
					//~ if (avatar.rotation>vehicle.rot_expected)
						//~ avatar.rotation -= 0.05;
					//~ else 
						//~ avatar.rotation += 0.05;
					vehicle.rot_diff = Math.abs(avatar.rotation-vehicle.rot_expected);
					
					//~ var angle = avatar.rotation;
					//~ var speed = 30;
					//~ avatar.body.velocity.x = Math.cos(angle) * speed;
					//~ avatar.body.velocity.y = Math.sin(angle) * speed;
				}
				else
				{
					this.vehicle_stop();
					//~ if (vehicle.pos_diff>30)
					//~ {
						//~ avatar.body.velocity.x = Math.cos(avatar.rotation) * 40;
						//~ avatar.body.velocity.y = Math.sin(avatar.rotation) * 40;
						//~ vehicle.calculate_pos_diff(avatar.body.x, avatar.body.y);
						//~ 
						//~ vehicle.rot_expected = game.physics.arcade.angleToXY(avatar,p.x,p.y);
						//~ vehicle.rot_diff = Math.abs(avatar.rotation-vehicle.rot_expected);
					//~ }
					//~ else
					//~ {
						//~ this.vehicle_stop();
						//~ this.bmd.clear();
					//~ }
				}
			},
			
			vehicle_setGoal: function () {
				if (game.time.now > vehicle.next_move) 
				{
					vehicle.next_move = game.time.now + vehicle.move_rate;
					p = {x:game.input.x, y:game.input.y};
					vehicle.rot_expected = game.physics.arcade.angleToXY(avatar,p.x,p.y);
					vehicle.rot_current = avatar.rotation;
					vehicle.rot_diff = Math.abs(avatar.rotation-vehicle.rot_expected);
					vehicle.pos_expected = p;
					vehicle.calculate_pos_diff(avatar.body.x, avatar.body.y);
					
					this.bmd.clear();
					this.bmd.rect(p.x-4,p.y-4, 8,8, 'rgba(200,230,200,1)');
					
					this.path.fromAngle(avatar.body.x + avatar.body.width/2,
										avatar.body.y + avatar.body.height/2,
										vehicle.rot_expected,
										vehicle.pos_diff);
					game.debug.geom(this.path);
				}
			},
			
			vehicle_stop: function() {
				avatar.body.velocity.x = 0;
				avatar.body.velocity.y = 0;
			},
			plot: function () {
				this.bmd.rect(avatar.body.x,avatar.body.y, 1,1, 'rgba(0,0,0,1)');
			},
		}

		game.state.add('main', main_state,true);
		//~ game.state.start('main');
	</script>
	<div id="div_slam">
	</div>
{% endblock %}
